<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8" />
	<title>Ejercicio Listado Personas. AJAX</title>
	<style type="text/css">
		h3 {
			color: red;
		}

		/* CSS para el formulario:   */
		.formPersonas {
			visibility: hidden;
			position: absolute;
			top: 20%;
			left: 20%;
			z-index: 11;
			background-color: pink;
			border: 2px solid maroon;
			border-radius: 15px;
			padding: 1em;
			color: red;

			/*opacity:0;   
			transition: all 1s;*/
		}
		.imagen{
			height: 150px;
			width: 150px;
		}

		.formPersonas div label {
			display: block;
			margin-top: .5em;
		}

		.formPersonas .btn {
			display: block;
			margin-top: 1em;
		}


		.ver {
			visibility: visible;
			opacity: 1;
		}
	</style>
	<!-- <script type="text/javascript" src="Utilidades.js"></script> -->
	<script src="jsstore.min.js"></script>
	<script src="jsstore.worker.min.js"></script>
	<script type="text/javascript">

		//ESTABLECIMIENTO DE LA CONEXIÓN
		var conexionBD = new JsStore.Connection(new Worker('jsstore.worker.min.js'));


		async function crearBD() {
			//Inicialización de los parámetros de la base de datos, primero nombre y después tabla/s
			var nombreDB = "listaPersonas";
			var tablaPersonas = {
				name: "Persona",
				columns: {
					id: { primaryKey: true, autoIncrement: true },
					dni: { notNull: true, dataType: "string" },
					nombre: { notNull: true, dataType: "string" },
					apellidos: { notNull: true, dataType: "string" },
					fechaNacimiento: { notNull: true, dataType: "date_time" },
					estatura: { dataType: "number" },
					imagenBlob: { notNull: false, dataType: "object" },
					imagen64: { notNull: false, dataType: "string" }
				},
				alter: {
					4: {
						add: {
							estadoCivil: {
								dataType: 'number',
								default: 1
							}
						}
					}
				}
			}
			var tabla2 = {
				name: "EstadoCivil",
				columns: {
					id: { primaryKey: true, autoIncrement: true },
					nombre: { dataType: "string" }
				}
			};

			//Creamos el objeto base de datos
			var db = {
				name: nombreDB,
				tables: [tablaPersonas, tabla2],
				version: 4
			}

			//Creación de la base de datos usando un método de la API JsStore, recibe el objeto recién creado
			const dbCreadaCorrectamente = await conexionBD.initDb(db);

			//Este condicional solo pasa por el primer caso una vez, una vez creada la BBDD, el booleano SIEMPRE es false
			if (dbCreadaCorrectamente) {
				console.log("Base de Datos creada correctamente");
				var value = {
					dni: '29498314D',
					nombre: 'José',
					apellidos: 'García De Lemus',
					fechaNacimiento: new Date(2001, 1, 10),
					estatura: 1.79,
					imagenBlob: null,
					imagen64: "picture"
				}
				var insertCount = await conexionBD.insert({
					values: value
				})
				console.log(`${insertCount} filas insertadas`);
			} else {
				console.log("Base de datos abierta, 0 datos insertados");
			}
			rellenarTabla();
		}//crearDB

		async function rellenarTabla() {
			var tabla = document.getElementById("filas_tabla");
			tabla.innerHTML = "";

			//SELECT
			var personas = await conexionBD.select({
				from: "Persona"
			});

			console.log(personas);

			personas = personas.map(element => {
				return [
					element.id,
					element.dni,
					element.nombre,
					element.apellidos,
					element.fechaNacimiento,
					element.estatura,
					element.estadoCivil,
					element.imagenBlob,
					element.imagen64
				]
			});

			console.log(personas);

			async function insertarFila(arrayFila) {
				console.log(arrayFila);
				let fila = document.createElement("tr");
				let casilla, contenido;
				arrayFila.forEach(function (e, i) {
					casilla = document.createElement("td");
					console.log(i);
					if (i == 7 || i == 8) {
						if (i == 8) {
							let imagen = document.createElement("img");
							imagen.src = e;
							imagen.style.height="200px";
							imagen.style.width="200px";
							casilla.appendChild(imagen);
						} else {
							// let blob = new Blob([ficheroImagen]);
							// casilla.appendChild(blob);
						}
					} else {
						contenido = document.createTextNode(e);
						casilla.appendChild(contenido);
					}
					fila.appendChild(casilla);
				});
				return fila;
			}

			personas.forEach(persona => {
				let fila = insertarFila(persona);

				let borrarBut = document.createElement("button");
				borrarBut.appendChild(document.createTextNode("Borrar"));
				borrarBut.dataset.id = persona[0];
				borrarBut.dataset.nombre = persona[2] + " " + persona[3];
				let editarBut = document.createElement("button");
				editarBut.appendChild(document.createTextNode("Editar"));
				editarBut.dataset.id = persona[0];
				let casilla1 = document.createElement("td");
				casilla1.appendChild(borrarBut);
				let casilla2 = document.createElement("td");
				casilla2.appendChild(editarBut);

				fila.appendChild(casilla1);
				fila.appendChild(casilla2);

				borrarBut.addEventListener("click", deletePersona);
				editarBut.addEventListener("click", mostrarFormEditar);

				tabla.appendChild(fila);
			});
		}//rellenarTabla

		//FUNCIÓN PARA BORRAR PERSONAS
		async function deletePersona() {
			if (confirm("¿Desea borrar a la persona " + this.dataset.nombre + "?")) {
				var rowsDeleted = await conexionBD.remove({
					from: "Persona",
					where: {
						id: parseInt(this.dataset.id)
					}
				});
			}
			alert(rowsDeleted + " filas borradas.");

			rellenarTabla();
		}


		//Función para añadir o actualizar una persona
		async function updatePersona() {
			console.log(document.getElementById("fecha").value);

			if (document.getElementById("fecha").value == "") {
				alert("Se debe seleccionar una fecha válida");
				return false;
			}

			let dni = document.getElementById("dni").value;
			let nombre = document.getElementById("nombre").value;
			let apellidos = document.getElementById("apellidos").value;
			let fechaNac = new Date(document.getElementById("fecha").value);
			let estatura = parseFloat(document.getElementById("estatura").value);
			let estadoCivil = parseInt(document.getElementById("estadoCivilId").value);
			let imagenBlob = null;
			let imagen64 = document.getElementById("imagen").src;
			if(estadoCivil == -1){
				estadoCivil = 1;
			}

			if (this.dataset.id == -1) {
				var value = {
					dni: dni,
					nombre: nombre,
					apellidos: apellidos,
					fechaNacimiento: fechaNac,
					estatura: estatura,
					estadoCivil: estadoCivil,
					imagenBlob: imagenBlob,
					imagen64: imagen64
				};

				var filasInsertadas = await conexionBD.insert({
					into: "Persona",
					values: [value]
				});

				console.log(`${filasInsertadas} filas insertadas`);

				document.getElementById("dni").value = "DNI";
				document.getElementById("nombre").value = "NOMBRE";
				document.getElementById("apellidos").value = "APELLIDOS";
				document.getElementById("fecha").value = "";
				document.getElementById("estatura").value = "ESTATURA";
				document.getElementById("estadoCivilId").value = -1;

				ocultarFormulario();
				rellenarTabla();
			} else {
				var filasActualizadas = await conexionBD.update({
					in: "Persona",
					set: {
						dni: dni,
						nombre: nombre,
						apellidos: apellidos,
						fechaNacimiento: fechaNac,
						estatura: estatura,
						estadoCivil: estadoCivil,
						imagenBlob: imagenBlob,
						imagen64: imagen64
					},
					where: {
						id: parseInt(this.dataset.id)
					}
				});

				console.log(`${filasActualizadas} filas actualizadas`);

				document.getElementById("dni").value = "DNI";
				document.getElementById("nombre").value = "NOMBRE";
				document.getElementById("apellidos").value = "APELLIDOS";
				document.getElementById("fecha").value = "";
				document.getElementById("estatura").value = "ESTATURA";
				document.getElementById("estadoCivilId").value = -1;

				ocultarFormulario();
				rellenarTabla();
			}
		}

		//Función que lee la imagen x64
		function leerImagen() {
			var fichero = this.files[0];
			ficheroImagen = this.files[0];
			console.log("fichero", fichero);
			var reader = new FileReader();
			reader.onloadend = () => {
				console.log("contenido", reader.result);
				document.getElementById("imagen").src = reader.result;
			}
			reader.readAsDataURL(fichero);
		}

		//Función que muestra el formulario de inserción con los valores de la persona seleccionada
		async function mostrarFormEditar() {

			let persona = await conexionBD.select({
				from: "Persona",
				where: {
					id: parseInt(this.dataset.id)
				}
			});

			console.log(new Date(persona[0].fechaNacimiento));
			let fecha = new Date(persona[0].fechaNacimiento);
			let fechaHtml = fecha.getFullYear + "-" + fecha.getMonth + "-" + fecha.getDay;

			document.getElementById("dni").value = persona[0].dni;
			document.getElementById("nombre").value = persona[0].nombre;
			document.getElementById("apellidos").value = persona[0].apellidos;
			document.getElementById("fecha").value = fechaHtml;
			document.getElementById("estatura").value = persona[0].estatura;
			document.getElementById("btAnade").dataset.id = this.dataset.id;
			document.getElementById("btAnade").innerHTML = "Editar";

			document.getElementById("formPersonas").style.visibility = "visible";
		}

		//Función para mostrar el formulario de inserción
		function mostrarFormInsertar() {
			document.getElementById("formPersonas").style.visibility = "visible";
			document.getElementById("btAnade").dataset.id = -1;
			document.getElementById("btAnade").innerHTML = "Añadir";
		}

		//Función que oculta formulario
		function ocultarFormulario() {
			document.getElementById("formPersonas").style.visibility = "hidden";
		}

		//Función para llenar el Select
		async function llenarSelect(op) {
			var estadosCiviles = await conexionBD.select({
				from: "EstadoCivil"
			});
			for (var i = 0; i < estadosCiviles.length; i++) {
				op.options[op.options.length] = new Option(estadosCiviles[i].nombre, estadosCiviles[i].id);
			}
		}

		window.onload = function () {
			crearBD();
			llenarSelect(document.getElementById("estadoCivilId"));
			document.getElementById("btNuevaPersona").onclick = mostrarFormInsertar;
			document.getElementById("btCancelar").onclick = ocultarFormulario;
			document.getElementById("btAnade").addEventListener("click", updatePersona);
			document.getElementById("fImagen").addEventListener("change", leerImagen);


		}
	</script>
</head>

<body>
	<h3>Registro de Usuarios</h3>

	<div id="formPersonas" class="formPersonas">
		<fieldset>
			<legend>Alta en el servicio</legend>
			<div>
				<label for="dni">DNI</label>
				<input type="text" id="dni" size="10" maxlength="9" value="DNI" />
			</div>
			<div>
				<label for="nombre">Nombre</label>
				<input type="text" id="nombre" value="NOMBRE" />
			</div>
			<div>
				<label for="apellidos">Apellidos</label>
				<input type="text" id="apellidos" size="40" value="APELLIDOS" />
			</div>
			<div>
				<label for="fecha">Fecha de nacimiento</label>
				<input type="date" id="fecha" />
			</div>
			<div>
				<label for="estatura">Estatura</label>
				<input type="text" id="estatura" size="40" value="00" />
			</div>
			<div>
				<label for="estadoCivilId">Estado Civil</label>
				<select id="estadoCivilId">
					<option value="-1">Seleccione un estado civil</option>
				</select>
			</div>
			<div>
				<label for="fImagen">Imagen</label>
				<input type="file" id="fImagen" />
			</div>
			<div>
				<img id="imagen" class="imagen" src="">
			</div>
			<div class="btn">
				<button id="btAnade">Añadir </button>
				<button id="btCancelar">Cancelar </button>
			</div>
		</fieldset>
	</div>



	<br />
	<button class="btn" id="btNuevaPersona">Nueva persona</button>
	<br><br>
	<table id="tabla_personas" border="1">
		<tr>
			<th>ID</th>
			<th>DNI</th>
			<th>NOMBRE</th>
			<th>APELLIDOS</th>
			<th>FECHA DE NACIMIENTO</th>
			<th>ESTATURA</th>
			<th>ESTADO CIVIL</th>
			<th>BLOB</th>
			<th>x64</th>
			<th>Borrar</th>
			<th>Editar</th>
		</tr>

		<tbody id="filas_tabla">

		</tbody>
	</table>

	<br><br>

</body>

</html>